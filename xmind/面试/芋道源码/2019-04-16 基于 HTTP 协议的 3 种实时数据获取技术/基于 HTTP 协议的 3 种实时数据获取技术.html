<!DOCTYPE html>
<head>
	<meta http-equiv='Content-Type' content='text/html;charset=utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'>
	<title>
		基于 HTTP 协议的 3 种实时数据获取技术
	</title>
	<script src='https://cdn.bootcss.com/jquery/1.10.2/jquery.min.js'>
	</script>
	<style>
		a {color: #607fa6;text-decoration:none;word-wrap:break-word;word-break:break-all;}.rich_media_title{padding-bottom:10px;margin-bottom:14px;border-bottom:1px
		solid #e7e7eb;}.rich_media_meta{display:inline-block;vertical-align:middle;margin-right:8px;margin-bottom:10px;font-size:16px;}.rich_media_meta_text{color:#8c8c8c;}.rich_media_meta_list
		em {font-style: normal;}@media screen and (max-width:768px){.rich_media{position:
		relative;padding: 20px 15px 15px;background-color: #fff;}}.rich_media_content
		* {max-width: 100%!important;box-sizing: border-box!important;-webkit-box-sizing:
		border-box!important;word-wrap: break-word!important;}.rich_media_content
		blockquote {margin: 0;padding-left: 10px;border-left: 3px solid #dbdbdb;}.rich_media_content
		.list-paddingleft-2 {padding-left: 2.2em;}a.rich_media_meta_nickname{display:
		none;}@media screen and (min-width:1025px){.rich_media{position:relative;}a.rich_media_meta_nickname{display:inline-block!important;}span.rich_media_meta_nickname
		{display: inline-block!important;}.rich_media {width:670px;margin-left:auto;margin-right:auto;}}a.fwjm{display:
		block;font-size: 12px;color: #ececec;}.tenvideo_player {position: relative;width:
		100 %;height: 100 %;margin: auto;background: #000;}* {margin:0px;padding:0px}
		.dy_all {text-align: center;margin: 30px 0;} .dy_all a {display: inline-block;height:
		38px;line-height: 38px;padding: 0 18px;background-color: #009688;color:
		#fff;white-space: nowrap;font-size: 14px;border: none;border-radius: 2px;cursor:
		pointer;text-align: center;outline: 0;-webkit-appearance: none;transition:
		all .3s;-webkit-transition: all .3s;box-sizing: border-box;}
	</style>
</head>
<body>
	<div id='js_article' class='rich_media'>
		<div>
			<a href='https://mp.weixin.qq.com/s/K89Z3cZuFc3lTw7pGzqMrw' target='_blank'>
				https://mp.weixin.qq.com/s/K89Z3cZuFc3lTw7pGzqMrw
			</a>
			<br/>
			<a href='https://www.52pojie.cn' class='fwjm' target='_blank'>
				提供的爬取软件来源于：52pojie.cn@夜泉 免费下载使用
			</a>
		</div>
		<div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">基于 HTTP 协议的 3 种实时数据获取技术</h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                                                <span class="rich_media_meta rich_media_meta_text">
                                                五月的仓颉
                                            </span>
                                        
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);">芋道源码</a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">芋道源码</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">javayuanma</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">纯 Java 源码分享公众号，目前有「Dubbo」「SpringCloud」「Java 并发」「RocketMQ」「Sharding-JDBC」「MyCAT」「Elastic-Job」「SkyWalking」「Spring」等等</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text">2019-04-16</em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;color: rgb(51, 51, 51);font-family: -apple-system-font, system-ui, &#39;Helvetica Neue&#39;, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;font-size: 17px;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);" data-mpa-powered-by="yiban.io"><p style="color: rgb(0, 0, 0);font-size: 16px;text-align: center;"><span style="color: rgb(127, 127, 127);font-size: 14px;line-height: 1.75em;">点击上方“</span><span style="font-size: 14px;line-height: 1.75em;color: rgb(0, 176, 240);">芋道源码</span><span style="color: rgb(127, 127, 127);font-size: 14px;line-height: 1.75em;">”，选择“<a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486188&amp;idx=3&amp;sn=f160d91ea23e5113e6077c500a2e30c4&amp;chksm=fa49755dcd3efc4bf4f566fbbbf74c191d0b79f2d3222fd211bc52d80b5ef127f52b1158ed71&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2">设为星标</a>”</span></p><p style="font-size: 16px;color: rgb(62, 62, 62);text-align: center;"><span style="color: rgb(127, 127, 127);font-size: 14px;">做积极的人，而不是积极废人！</span></p><section style="color: rgb(0, 0, 0);font-size: medium;line-height: normal;"><section><section><section data-mpa-template-id="692363" data-mpa-color="null" data-mpa-category="fav"><section><section style="margin-top: 10px;margin-bottom: 10px;"><section style="padding-right: 1em;padding-left: 1em;display: inline-block;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: center;"><span style="padding: 0.3em 0.5em;display: inline-block;border-radius: 0.5em;font-size: 13px;color: rgb(255, 255, 255);background-color: rgb(95, 156, 239);"><p>源码精品专栏</p></span>&nbsp;</section><section style="margin-top: -1em;padding: 20px 10px 10px;border-width: 1px;border-style: solid;border-color: rgb(192, 200, 209);text-align: center;background-color: rgb(239, 239, 239);"><section><section><section style="text-align: left;"><ul class=" list-paddingleft-2" mpa-from-tpl="t" style="list-style-type: circle;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486264&amp;idx=1&amp;sn=475ac3f1ef253a33daacf50477203c80&amp;chksm=fa497489cd3efd9f7298f5da6aad0c443ae15f398436aff57cb2b734d6689e62ab43ae7857ac&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline;font-size: 10px;" data-linktype="2"><span style="font-size: 10px;">中文详细注释的开源项目</span></a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247484647&amp;idx=1&amp;sn=9eb7e47d06faca20d530c70eec3b8d5c&amp;chksm=fa497b56cd3ef2408f807e66e0903a5d16fbed149ef7374021302901d6e0260ad717d903e8d4&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 10px;text-decoration: underline;" data-linktype="2"><span style="font-size: 10px;">RPC 框架 Dubbo 源码解析</span></a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247485054&amp;idx=2&amp;sn=9f3b85f7b8454634da6c5c2ded9b4dba&amp;chksm=fa4979cfcd3ef0d9d2dd92d8d1bd8f1553abc6e2095a5d743e0b2c2afe4955ea2bbbd7a4b79d&amp;token=55862109&amp;lang=zh_CN&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 10px;text-decoration: underline;" data-linktype="2"><span style="font-size: 10px;">网络应用框架 Netty 源码解析</span></a><br  /></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486256&amp;idx=1&amp;sn=81daccd3fcd2953456c917630636fb26&amp;chksm=fa497481cd3efd97d9239f5eab060e49dea9876a6046eadba0effb878d2fb51f3ba5733e4c0b&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">消息中间件 RocketMQ 源码解析</span></a><br  /></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486257&amp;idx=1&amp;sn=4d3c9c675f8833157641a2e0b48e498c&amp;chksm=fa497480cd3efd96fe17975b0b8b141e87fd0a62673e6a30b501460de80b3eb997056f09de08&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">数据库中间件 Sharding-JDBC 和 MyCAT 源码解析</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486258&amp;idx=1&amp;sn=ae5665ae9c3002b53f87cab44948a096&amp;chksm=fa497483cd3efd950514da5a37160e7fd07f0a96f39265cf7ba3721985e5aadbdcbe7aafc34a&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">作业调度中间件 Elastic-Job 源码解析</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486259&amp;idx=1&amp;sn=b023cf3dbf97e5da59db2f4ee632f5a6&amp;chksm=fa497482cd3efd9402d71469f71863f71a6998b27e12ca2e00446b8178d79dcef0721d8e570a&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">分布式事务中间件 TCC-Transaction 源码解析</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486260&amp;idx=1&amp;sn=8f14c0c191d6f8df6eb34202f4ad9708&amp;chksm=fa497485cd3efd93937143a648bc1b530bc7d1f6f8ad4bf2ec112ffe34dee80b474605c22db0&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">Eureka 和 Hystrix 源码解析</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&amp;mid=2247486261&amp;idx=1&amp;sn=bd69f26aadfc826f6313ffbb95e44ee5&amp;chksm=fa497484cd3efd92352d6fb3d05ccbaebca2fafed6f18edbe5be70c99ba088db5c8a7a8080c1&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" style="text-decoration: underline;font-size: 10px;"><span style="font-size: 10px;">Java 并发源码</span></a></p></li></ul></section></section></section></section></section></section></section></section></section></section></section><p mpa-paragraph-type="body" style="white-space: normal;font-family: -apple-system-font, system-ui, &#39;Helvetica Neue&#39;, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;letter-spacing: 0.544px;text-align: right;background-color: rgb(255, 255, 255);color: rgb(51, 51, 51);font-size: 17px;"><span style="font-size: 10px;color: rgb(136, 136, 136);">来源：http://t.cn/E6rUVEV</span></p><blockquote style="margin-top: 0px;margin-left: 2em;padding-top: 0px;padding-left: 1em;color: rgb(153, 153, 153);border-left-width: 1px;border-left-color: rgb(26, 188, 156);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><ul style="" class=" list-paddingleft-2"><li><p>HTTP协议</p></li><li><p>方式一：短轮询</p></li><li><p>方式二：长轮询</p></li><li><p>方式三：WebSocket</p></li></ul></blockquote><hr style="box-sizing: content-box;margin-top: 16px;margin-bottom: 16px;border-width: 0px;border-style: none;border-color: initial;height: 2px;background-color: rgb(231, 231, 231);color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;"  /><h1 style="margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;font-weight: bold;line-height: 1.225;cursor: text;font-size: 1.2rem;border-bottom: 1px solid rgb(221, 221, 221);color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">HTTP协议</h1><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">HTTP协议大家都很熟悉了，开始本文之前，首先简单回顾一下HTTP协议。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">HTTP协议是建立在TCP协议上的应用层协议，协议的本质是请求----应答：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.34802431610942247" src="images\0001.jpg" data-type="jpeg" data-w="658" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">即对于HTTP协议来说，服务端给一次响应后整个请求就结束了，这是HTTP请求最大的特点，也是由于这个特点，HTTP请求无法做到的是服务端向客户端主动推送数据。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">但由于HTTP协议的广泛应用，很多时候确实又想使用HTTP协议去实现实时的数据获取，这种时候应当怎么办呢？下面首先介绍几种基于HTTP协议的实时数据获取方法。</p><h1 style="margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;font-weight: bold;line-height: 1.225;cursor: text;font-size: 1.2rem;border-bottom: 1px solid rgb(221, 221, 221);color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">方式一：短轮询</h1><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">轮询是最普遍的基于HTTP协议获取实时数据的方式，轮询又分为短轮询和长轮询。短轮询非常简单，用一张图表示一下：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.5630372492836676" src="images\0002.jpg" data-type="jpeg" data-w="698" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">客户端向服务端请求数据，服务端立即将数据返回给客户端，客户端没有拿到想要的数据（比如返回结果告诉客户端，数据处理中），客户端继续发请求，服务端继续立即响应，周而复始。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">这种实时数据获取的方式比较粗暴，优点在于编程简单，客户端发请求，服务端实时回响应即可。缺点主要有两个：</p><ul style="" class=" list-paddingleft-2"><li><p>无效请求多，每一次无效请求都在浪费带宽和服务器的计算资源</p></li><li><p>对服务器压力大，定时发请求，并发一高，可能服务端瞬间会收到成千上万个请求，很容易拖垮服务器甚至导致宕机</p></li></ul><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">那么短轮询适合哪种使用场景呢，按照我的理解如果数据变化比较频繁或者能预期到数据在短时间内会发生一次变化的场景可以使用短轮询，比如：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.3023255813953488" src="images\0003.jpg" data-type="jpeg" data-w="516" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">用户在PC端买了一个东西唤起网页端，由于PC端和网页端是不通的，我们预期到用户应该很快会完成付款，这种时候为了开发简单短轮询是一种可以使用的方式，直接服务端提供一个接口告诉客户端订单状态，客户端每5秒请求一次即可，拿到结果就可以不用请求了。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">使用短轮询注意要做好请求次数上限的控制，比如请求100次还没检测到用户付款，可以弹窗"请完成付款后去我的订单页面查询"就可以不用请求了。</p><h1 style="margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;font-weight: bold;line-height: 1.225;cursor: text;font-size: 1.2rem;border-bottom: 1px solid rgb(221, 221, 221);color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">方式二：长轮询</h1><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">长轮询是另一种实时获取数据的方式，看一下流程：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.7491103202846975" src="images\0004.jpg" data-type="jpeg" data-w="562" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">本质上没有改变，依然是客户端在没有收到自己想要数据的情况下不断发送请求给服务端，差别在于服务端收到请求不再直接给响应，而是将请求挂起，自己去定时判断数据的变化，有变化就立马返回给客户端，没有就等到超时为止。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">可以很明显的看到，长轮询的优点就是客户端的请求少了很多避免了无谓的客户端请求，缺点则是服务端会挂起大量请求增加资源消耗且服务器对HTTP请求并发数量是有限制的。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">微信网页版的登陆是一个典型的长轮询的例子：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.597877358490566" src="images\0005.jpg" data-type="jpeg" data-w="848" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">从图上看，客户端不断发送请求到服务器，服务器第一时间并没有给出回应，于是客户端等待，在超时的情况下继续发送请求。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">总的来说我理解一般使用长轮询会更多一点，短轮询更加看重的是编程简单，适合小型应用。像微信网页端登录这种，成千上万个用户同时登陆，隔一段时间服务端收成千上个请求去处理哪里受得了，堆机器分摊每台服务器上处理请求的数量终究不是解决问题的办法。</p><h1 style="margin-top: 35px;margin-bottom: 15px;padding-bottom: 0.5em;font-weight: bold;line-height: 1.225;cursor: text;font-size: 1.2rem;border-bottom: 1px solid rgb(221, 221, 221);color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">方式三：WebSocket</h1><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">上面介绍了两种轮询方式，但是两种综合起来都有比较明显的缺点，总结起来有以下几个：</p><ul style="" class=" list-paddingleft-2"><li><p>伪实时，即上述两种方式都不是真正的实时，无论短轮询的客户端轮询时间多短，还是长轮询的服务端轮询时间多短，都存在一定程度的延时</p></li><li><p>所有的轮询只要没有需要的数据返回，都是对计算资源的一种浪费</p></li><li><p>HTTP协议本身是一个重的协议，每一次都必须带有HTTP首部+HTTP头部，实际上对我们来说需要的只是HTTP Body而已，多余的数据都是对带宽的一种浪费</p></li></ul><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">因此，最好我们可以做到的事情是：客户端和服务端之间有一条通路，当服务端数据有变化的时候，服务端可以主动推送到客户端。WebSocket就是HTML5之后为了做到这一点而诞生的一种协议，虽然这是一种新的协议，但也是基于HTTP协议的。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">看一下WebSocket的原理，很简单：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.598116169544741" src="images\0006.jpg" data-type="jpeg" data-w="637" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">WebSocket客户端首先通过HTTP协议发送几个特别的header到服务端，告诉服务端现在我发起的是HTTP请求，但我要升级到WebSocket了：</p><ul style="" class=" list-paddingleft-2"><li><p>Upgrade:websocket</p></li><li><p>Connection：Upgrade</p></li><li><p>Sec-WebSocket-Key:&nbsp;XXX</p></li><li><p>Sec-WebSocket-Protocol:&nbsp;chat,&nbsp;superchat</p></li><li><p>Sec-WebSocket-Version:&nbsp;XX</p></li></ul><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">只要服务器支持WebSocket协议（Tomcat7、Jetty7之后都是支持WebSocket的），那么服务端收到请求且建立连接成功后会返回Sec-WebSocket-Accept、Sec-WebSocket-Protocol这两个header给客户端，且Http&nbsp;Status为101表示协议切换成功，这样客户端和服务端只要任意一方没有断开连接，就可以基于这一条通路进行通讯了。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">再谈一下之前提的WebSocket相比长短轮询对于带宽资源的节省。有一个测试，假设HTTP&nbsp;Header是871字节，WebSocket由于数据传输是基于帧的，帧传输更加高效，对比长短轮询，2个字节即可代替871个字节的Header，测试结果为：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.7157057654075547" src="images\0007.jpg" data-type="jpeg" data-w="503" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">相同的每秒客户端轮询的次数，当次数高达10W/s的高频率次数的时候，轮询需要消耗665Mbps，而WebSocket仅仅只花费了1.526Mbps，将近435倍。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">WebSocket做到了真正的实时且大量节省带宽资源，但是我理解也有自己的问题，就是开发成本比较高，这里的开发成本倒不是说自己去实现WebSocket，这个在Java语言层面上直接使用Netty-Socketio即可，API很简单，提供了对WebSocket完整的实现，真正的开发成本在于分布式环境下的数据同步问题。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">举个例子，有一个在线聊天系统10W人同时在线，此时有一个用户发了一条1K的语音消息，单机保持10W的连接倒是可以（这里不是HTTP请求，因此不受连接池数影响），问题在于带宽。单机同时向10W用户推送1K语音消息，需要的带宽至少10M，这还只是纯粹推送数据出去，没有考虑到数据进来的场景，实际运行过程中需要的带宽会更多，对于企业来说这是一笔非常大的成本。</p><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">因此，大量连接的场景下都会做集群（实际就算没有大量连接，为了高可用性，也会做集群），10W并发分出5台机器，平均每台机器有2W连接，考虑集群下会出现的问题：</p><figure style="color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><img class="" data-ratio="0.43687150837988825" src="images\0008.jpg" data-type="jpeg" data-w="895" style="margin-right: auto;margin-left: auto;border-width: 2px;border-style: solid;border-color: rgb(238, 238, 238);border-radius: 6px;display: block;" title=""  /></figure><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">客户端1把数据发送到服务器1，服务器1连接的所有客户端都可以推送该条语音，但是问题在于：</p><ul style="" class=" list-paddingleft-2"><li><p>服务器2~服务器5连的所有客户端如何拿到数据？简单的一种方式是使用消息队列，将数据通过消息队列发送到所有订阅的服务器上</p></li><li><p>那如果传输的是一张1M的图片，数据太大不适合使用消息队列怎么办，可以先将数据存储下来，消息队列只发送id，收到消息的服务器再根据id去取真正的数据并推送</p></li><li><p>如果依赖消息队列，那么不仅仅需要对应用进行代码开发，还需要对消息服务器做分布式集群、做压力测试，保证高可用</p></li><li><p>2W连接正常预计发送1K的消息是没问题的，但是万一用户发送了1M图片导致远超预估带宽怎么办，是业务上取舍不能发送超过XXX的数据还是技术上处理</p></li></ul><p style="margin-top: 0.8em;margin-bottom: 0.8em;color: rgb(52, 73, 94);font-family: &quot;Source Sans Pro&quot;, &quot;Helvetica Neue&quot;, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);">其他太多需要考虑的问题没有列出来，总而言之，用WebSocket在大量请求、高并发的场景下，代码开发成本是非常高的。但是由于WebSocket可以做到真正的实时服务端对客户端的数据推送且对带宽资源有大量的节省，因此很多IM、音视频、弹幕等应用都会使用WebSocket。</p><p mpa-paragraph-type="body" style="white-space: normal;font-family: -apple-system-font, system-ui, &#39;Helvetica Neue&#39;, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);color: rgb(51, 51, 51);font-size: 17px;"><br  /></p><hr style="white-space: normal;font-family: -apple-system-font, system-ui, &#39;Helvetica Neue&#39;, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);"  /><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;font-family: -apple-system-font, system-ui, &#39;Helvetica Neue&#39;, &#39;PingFang SC&#39;, &#39;Hiragino Sans GB&#39;, &#39;Microsoft YaHei UI&#39;, &#39;Microsoft YaHei&#39;, Arial, sans-serif;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);"><hr style="border-style: solid;border-right-width: 0px;border-bottom-width: 0px;border-left-width: 0px;border-color: rgba(0, 0, 0, 0.1);transform-origin: 0px 0px 0px;transform: scale(1, 0.5);"  /><p style="margin-top: 1.7em;margin-bottom: 1.7em;color: rgb(62, 62, 62);font-size: 15px;line-height: inherit;letter-spacing: 2px;word-spacing: 2px;">欢迎加入我的知识星球，一起探讨架构，交流源码。加入方式，<strong><span style="color: rgb(255, 76, 0);">长按下方二维码噢</span></strong>：<br  /></p></section><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="white-space: normal;color: rgb(51, 51, 51);font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 17px;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);"><p style="text-align: center;"><img class="" data-copyright="0" data-cropselx1="0" data-cropselx2="556" data-cropsely1="0" data-cropsely2="370" data-ratio="0.56" data-s="300,640" src="images\0009.jpg" data-type="jpeg" data-w="900" style="width: 556px;height: 311px;"  /></p><p style="text-align: left;">已在知识星球更新源码解析如下：<br  /></p><section data-role="outer" label="Powered by 135editor.com" style="font-size: 16px;font-family: 微软雅黑;"><p style="text-align: center;"><img class="" data-ratio="0.9442815249266863" data-s="300,640" src="images\0010.jpg" data-type="png" data-w="1364" style=""  /></p><p style="text-align: center;"><img class="rich_pages" data-ratio="1.035190615835777" data-s="300,640" src="images\0011.jpg" data-type="png" data-w="1364" style=""  /></p><p style="text-align: center;"><img class="" data-ratio="0.7178002894356006" data-s="300,640" src="images\0012.jpg" data-type="png" data-w="1382" style=""  /><br  /></p><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="letter-spacing: 0.544px;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="font-size: 16px;font-family: 微软雅黑;box-sizing: border-box !important;"><section data-mpa-template="t" class="" mpa-paragraph-type="ignored" style="letter-spacing: 0.544px;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="box-sizing: border-box !important;"><p class="" style="text-align: right;box-sizing: border-box !important;"><span style="color: rgb(255, 41, 65);box-sizing: border-box !important;"><strong style="box-sizing: border-box !important;">如果你喜欢这篇文章，喜欢，转发。</strong></span></p><p class="" style="text-align: right;box-sizing: border-box !important;"><span style="color: rgb(255, 41, 65);box-sizing: border-box !important;"><strong style="box-sizing: border-box !important;">生活很美好，明天见(｡･ω･｡)ﾉ♡</strong></span></p></section></section></section></section></section></section>
                </div>
                

                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">五月的仓颉</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p>
                        <a class="reward_button" id='js_preview_reward_author_link' href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x42f400.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                
                
                            </div>
	</div>
	<div class='dy_all'>
		<a href='http://www.iocoder.cn/Dubbo/good-collection/?mp' target='_blank'>
			阅读全文
		</a>
	</div>
</body>